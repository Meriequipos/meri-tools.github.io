<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Altas de Productos | Meri-Tools</title>
  <link rel="stylesheet" href="../styles.css" />
  <link rel="icon" href="img/favicon.ico" type="image/x-icon" />
</head>
<body>
  <header>
    <div class="logo">
  <img src="img/Meri-Tools.svg" alt="Logo Meri-Tools">
</div>
    </div>
    <nav>
      <ul>
        <li><a href="../index.html">Inicio</a></li>
        <li><a href="">Herramientas</a></li>
        <li><a href="#">Guías</a></li>
        <li><a href="mailto:contacto@meriequipos.com?subject=Sugerencia%20-%20Meri-Tools">Sugerencias</a></li>
      </ul>
    </nav>
  </header>

  <main>
    <section class="bienvenida">
      <h2>Formato de Alta de Productos</h2>
      <p>Llena los campos con la información correspondiente para generar tu tabla.</p>
    </section>

    <form id="productForm">
    <div class="row">
      <div>
        <label>Catálogo del producto</label>
        <input type="text" id="catalogoProducto" required />
      </div>
      <div>
        <label>Catálogo SAT (Obligatorio)</label>
        <input type="text" id="catalogoSAT" required />
      </div>
    </div>

    <label>Nombre del producto</label>
    <input type="text" id="nombreProducto" required />

    <div class="row">
      <div>
        <label>Modelo</label>
        <input type="text" id="modelo" required />
      </div>
      <div>
        <label>Marca</label>
        <input type="text" id="marca" required />
      </div>
    </div>

    <label>Encabezado o descripción corta (se genera automáticamente)</label>
    <input type="text" id="descripcionCorta" readonly />
    <div class="char-counter" id="contadorCaracteres">0 / 100</div>
    <div id="charLimitMsg" class="limit-msg"></div>

    <label>Imagen (opcional)</label>
    <input type="file" id="imagen" accept="image/*" />
    <div id="imagenDrop">Pega una imagen aquí desde el portapapeles</div>
    <img id="preview" class="image-preview" />

    <label>Proveedor</label>
    <input type="text" id="proveedor" required />

    <label>Descripción ampliada</label>
    <textarea id="descripcionLarga" rows="4" placeholder="Puedes pegar texto con viñetas o puntos."></textarea>

    <button type="button" onclick="agregarProducto()">Agregar producto</button>
  </form>

  <div class="table-container">
    <h3>Productos agregados</h3>
    <p class="instruction-text">Una vez que agregues todos tus productos, puedes copiar la tabla de abajo y pegarla a un "nuevo correo" para solicitar tus altas.</p>
    <table id="tablaProductos">
      <thead>
        <tr>
          <th>Catálogo</th>
          <th>Descripción corta</th>
          <th>Catálogo SAT (Obligatorio)</th>
          <th>Imagen</th>
          <th>Proveedor</th>
          <th>Descripción ampliada</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  </main>

  <footer>
    <p>📩 ¿Tienes sugerencias? Escríbenos a <a href="mailto:contacto@meriequipos.com?subject=Sugerencia%20-%20Meri-Tools">contacto@meriequipos.com</a></p>
    <p>Última actualización: junio 2025</p>
  </footer>

  <script>
    const descripcionInput = document.getElementById("descripcionCorta");
    const msg = document.getElementById("charLimitMsg");
    const contador = document.getElementById("contadorCaracteres");

    function actualizarDescripcion() {
      let nombre = document.getElementById("nombreProducto").value.toUpperCase();
      let modelo = document.getElementById("modelo").value.toUpperCase();
      let marca = document.getElementById("marca").value.toUpperCase();

      let texto = `${nombre}´ MODELO ${modelo} MARCA ${marca}`;
      let totalLength = texto.length;

      if (totalLength > 100) {
        texto = texto.substring(0, 100);
        msg.textContent = "⚠️ Sobrepasaste el límite de 100 caracteres.";
      } else {
        msg.textContent = "";
      }

      descripcionInput.value = texto;
      contador.textContent = `${texto.length} / 100`;
    }

    ["nombreProducto", "modelo", "marca"].forEach(id => {
      document.getElementById(id).addEventListener("input", actualizarDescripcion);
    });

    document.getElementById("descripcionLarga").addEventListener("paste", function (e) {
      e.preventDefault();
      const text = (e.clipboardData || window.clipboardData).getData('text');
      document.execCommand("insertText", false, text);
    });

    document.getElementById("imagen").addEventListener("change", function () {
      const file = this.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
          document.getElementById("preview").src = e.target.result;
        };
        reader.readAsDataURL(file);
      }
    });

    document.getElementById("imagenDrop").addEventListener("paste", function (e) {
      const items = e.clipboardData.items;
      for (let i = 0; i < items.length; i++) {
        if (items[i].type.indexOf("image") !== -1) {
          const blob = items[i].getAsFile();
          const reader = new FileReader();
          reader.onload = function (event) {
            document.getElementById("preview").src = event.target.result;
          };
          reader.readAsDataURL(blob);
        }
      }
    });

    let editIndex = null;

    function agregarProducto() {
      const datos = {
        catalogo: document.getElementById("catalogoProducto").value,
        descripcionCorta: document.getElementById("descripcionCorta").value,
        catalogoSAT: document.getElementById("catalogoSAT").value,
        imagen: document.getElementById("preview").src,
        proveedor: document.getElementById("proveedor").value,
        descripcionLarga: document.getElementById("descripcionLarga").value
      };

      if (editIndex !== null) {
        const fila = document.querySelector(`#tablaProductos tbody`).children[editIndex];
        fila.innerHTML = generarFilaHTML(datos, editIndex);
        editIndex = null;
      } else {
        const index = document.querySelectorAll("#tablaProductos tbody tr").length;
        const fila = document.createElement("tr");
        fila.innerHTML = generarFilaHTML(datos, index);
        document.querySelector("#tablaProductos tbody").appendChild(fila);
      }

      document.getElementById("productForm").reset();
      document.getElementById("descripcionCorta").value = "";
      document.getElementById("preview").src = "";
      contador.textContent = "0 / 100";
      msg.textContent = "";
    }

    function generarFilaHTML(datos, index) {
      return `
        <td>${datos.catalogo}</td>
        <td>${datos.descripcionCorta}</td>
        <td>${datos.catalogoSAT}</td>
        <td><img src="${datos.imagen}" width="50" /></td>
        <td>${datos.proveedor}</td>
        <td>${datos.descripcionLarga.replace(/\n/g, "<br>")}</td>
        <td class="actions">
          <button onclick="editarProducto(${index})">Editar</button>
        </td>
      `;
    }

    function editarProducto(index) {
      const fila = document.querySelector(`#tablaProductos tbody`).children[index].children;
      document.getElementById("catalogoProducto").value = fila[0].textContent;
      document.getElementById("descripcionCorta").value = fila[1].textContent;
      document.getElementById("catalogoSAT").value = fila[2].textContent;

      // Extraer Nombre, Modelo y Marca de la descripción corta para rellenar los campos
      const descCorta = fila[1].textContent;
      const regex = /(.*?)´ MODELO (.*?) MARCA (.*)/;
      const match = descCorta.match(regex);

      if (match) {
        document.getElementById("nombreProducto").value = match[1].trim();
        document.getElementById("modelo").value = match[2].trim();
        document.getElementById("marca").value = match[3].trim();
      } else {
        // En caso de que la descripción corta no siga el formato esperado, limpiar los campos
        document.getElementById("nombreProducto").value = "";
        document.getElementById("modelo").value = "";
        document.getElementById("marca").value = "";
      }

      document.getElementById("preview").src = fila[3].querySelector("img").src;
      document.getElementById("proveedor").value = fila[4].textContent;
      document.getElementById("descripcionLarga").value = fila[5].innerText.replace(/<br>/g, "\n");
      editIndex = index;
      actualizarDescripcion();
    }
  </script>
</body>
</html>
